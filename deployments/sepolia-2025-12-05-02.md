# ECS V2 Sepolia Deployment Report - 02 ‚úÖ

**Version:** 0.2.0-beta  
**Date:** December 5, 2025  
**Network:** Sepolia (Chain ID: 11155111)  
**Status:** ‚úÖ Fully Deployed & Verified  
**Deployment:** 02 (Second deployment today - first had verification issues)

## Overview

This is the **production-ready deployment** of ECS V2 with resolver update tracking. All contracts have been successfully deployed and **verified on Etherscan**. This deployment includes the new security feature that enables clients to enforce trust policies based on resolver age.

## Key Features

### Resolver Trust and Freshness Tracking
- **`resolverUpdated` timestamp** - Tracks when each resolver was last set or changed
- **`getResolverInfo(address)`** - Returns `(string label, uint128 resolverUpdated)`
- **Storage optimization** - Changed `expiration` from `uint256` to `uint128`
- **Security enhancement** - Clients can detect recent resolver changes that may indicate compromise

### Why This Matters

ECS strictly enforces a one-to-one relationship between labels and resolvers. While label owners can change resolvers (necessary for upgrades), this introduces a security concern. By exposing the `resolverUpdated` timestamp, ECS gives clients the tools to enforce their own security policies.

## Deployed Contracts ‚úÖ

All contracts successfully deployed and **verified on Etherscan**:

| Contract | Address | Status | Etherscan |
|----------|---------|--------|-----------|
| **ECSRegistry** | `0x2bA1277bD3f5638F605696cb974eD67Ef81767Ec` | ‚úÖ Verified | [View](https://sepolia.etherscan.io/address/0x2bA1277bD3f5638F605696cb974eD67Ef81767Ec) |
| **ECSRegistrar** | `0x47C680d3720dDc23250cF697466582829a0533Ce` | ‚úÖ Verified | [View](https://sepolia.etherscan.io/address/0x47C680d3720dDc23250cF697466582829a0533Ce) |
| **CredentialResolver** | `0xB5D67A9bEf2052cC600f391A3997D46854cabC22` | ‚úÖ Verified | [View](https://sepolia.etherscan.io/address/0xB5D67A9bEf2052cC600f391A3997D46854cabC22) |

## Verification Details

All 3 contracts passed Etherscan verification:

- **Compiler:** Solc 0.8.30
- **EVM Version:** Prague
- **Optimization:** Enabled
- **License:** MIT

**Verification GUIDs:**
- ECSRegistry: `y8edmfcwqmhllxpdtvz84jwpxkdri2ift9r9dux3t85ywvjtfs`
- ECSRegistrar: `tr82pfbph2tllpustcxezzyxfveykb2klrzt8rkaxncwb8ngw3`
- CredentialResolver: `7truj1rz9hghgfmejby7sfwjtnxqnxrgg31672az3gbgrsqr5v`

## Configuration

- **Root Name:** `ecs.eth`
- **Root Node:** `0xe436ba58406c69a63a9611a11eb52314c5c17ba9eaaa7dab8506fe8849517286`
- **Deployer:** `0xF8e03bd4436371E0e2F7C02E529b2172fe72b4EF`
- **Registrar Pricing:** ~0.001 ETH/year (32000 wei/second)
- **Min Commitment Age:** 60 seconds
- **Min Duration:** 60 seconds
- **Max Duration:** `type(uint64).max`
- **Label Length:** 3-64 characters

## Registration Details

### Commitment Information

- **Label:** `name-stars`
- **Duration:** 365 days (31536000 seconds)
- **Secret:** `0xb7aeeb9f39cd2c85249116d20fdce1e54a702d9ded55e359bbf10016a6184683`
- **Commitment Hash:** `0xb86eb050a4ee4fea5f326e2c41678eb9ca7db4f01ff4e265d2bd515c5b926089`

## Smart Contract Changes

### ECSRegistry.sol

**Modified Record Struct:**
```solidity
struct Record {
    address owner;
    string label;
    uint128 expiration;      // Changed from uint256
    uint128 resolverUpdated; // NEW: Tracks resolver changes
}
```

**New Function:**
```solidity
function getResolverInfo(address resolver_) 
    external view 
    returns (string memory label, uint128 resolverUpdated)
```

**Replaced Function:**
- ‚ùå `getLabelByResolver(address) returns (string)` (Removed)
- ‚úÖ `getResolverInfo(address) returns (string, uint128)` (New)

### SDK Changes (ecsjs)

**Updated API:**
```javascript
// Old API (removed)
const label = await getLabelByResolver(client, resolverAddress)

// New API
const { label, resolverUpdated } = await getResolverInfo(client, resolverAddress)
```

## Next Steps

### 1. Wait for Commitment Period (60 seconds) ‚è±Ô∏è

The commitment was made during deployment. Wait at least 60 seconds before proceeding.

### 2. Complete Registration üìù

Update your `.env` file:
```bash
cat deployments/sepolia-2025-12-05-02.env >> .env
```

Run the registration script:
```bash
source .env && forge script script/RegisterAndSetup.s.sol:RegisterAndSetup \
  --rpc-url $SEPOLIA_RPC_URL --broadcast -vvv
```

### 3. Transfer ENS Manager üîê

After registration completes, update the Manager of `ecs.eth` to the new ECSRegistry:

1. Go to [app.ens.domains](https://app.ens.domains)
2. Navigate to `ecs.eth`
3. Set **Manager** to: `0x2bA1277bD3f5638F605696cb974eD67Ef81767Ec`

### 4. Test the Deployment üß™

Test the new `getResolverInfo` function:

**Using cast:**
```bash
cast call 0x2bA1277bD3f5638F605696cb974eD67Ef81767Ec \
  "getResolverInfo(address)(string,uint128)" \
  0xB5D67A9bEf2052cC600f391A3997D46854cabC22 \
  --rpc-url $SEPOLIA_RPC_URL
```

**Using ecsjs:**
```bash
npm run hook
```

## Testing Resolver Trust

Example of implementing a trust policy:

```javascript
import { getResolverInfo, createECSClient, sepolia } from '@nxt3d/ecsjs'

const client = createECSClient({
  chain: sepolia,
  rpcUrl: 'https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY'
})

const { label, resolverUpdated } = await getResolverInfo(
  client, 
  '0xB5D67A9bEf2052cC600f391A3997D46854cabC22'
)

const MIN_RESOLVER_AGE = 90 * 24 * 60 * 60 // 90 days
const resolverAge = Math.floor(Date.now() / 1000) - Number(resolverUpdated)

if (resolverAge < MIN_RESOLVER_AGE) {
  console.warn(`‚ö†Ô∏è Resolver "${label}" changed ${Math.floor(resolverAge / 86400)} days ago`)
  console.warn(`Security review required before accepting credentials.`)
} else {
  console.log(`‚úÖ Resolver stable for ${Math.floor(resolverAge / 86400)} days`)
}
```

## Trust Policy Recommendations

Different applications should implement different trust policies:

- **High Security Apps** (wallets, financial): Require 90+ days of resolver stability
- **Standard Apps** (social, identity): Require 30 days of resolver stability
- **Low Risk Apps** (public profiles): Require 7 days of resolver stability
- **Development/Testing**: Accept any resolver age

## Deployment History

### Deployment 02 (December 5, 2025) - Current ‚úÖ
- ‚úÖ Fully deployed and verified on Etherscan
- ‚úÖ All 3 contracts verified successfully
- ‚úÖ Clean deployment with proper verification
- ‚úÖ All tests passing (64/64)

### Deployment 01 (December 5, 2025) - Failed
- ‚ùå Verification failed (bytecode mismatch)
- Deployment was stuck waiting for Etherscan
- Redeployed as deployment 02

### Previous Deployment (Dec 2, 2025 - 03)
The old deployment (Dec 2) did not have resolver tracking. This deployment adds:
- New `getResolverInfo` function (replaces `getLabelByResolver`)
- Added `resolverUpdated` timestamp tracking
- Storage optimizations (`uint128` instead of `uint256`)

## Gas Costs

Estimated gas used during deployment:
- **Total Gas:** 9,748,722 gas
- **Estimated Cost:** 0.000011220252591012 ETH
- **Gas Price:** 0.001150946 gwei

## Related Documentation

- [README.md](../README.md) - Project overview and usage
- [Resolver Trust Documentation](../README.md#resolver-trust-and-freshness) - Security policies
- [ENSIP: Resolver Info Text Record](https://github.com/nxt3d/ensips/blob/resolver-info-metadata/ensips/resolver-info-text-record.md) - Planned upgrade announcements

## Production Readiness

### ‚úÖ Checklist

- [x] All contracts deployed successfully
- [x] All contracts verified on Etherscan
- [x] Deployment script completed without errors
- [x] Test suite passing (64/64 tests)
- [x] Documentation updated
- [x] SDK updated with new API
- [ ] Registration completed (pending)
- [ ] ENS Manager transferred (pending)
- [ ] Live testing completed (pending)

## Deployment Logs

Full deployment logs saved to: `deployment-v02.log` (note: "v02" in filename refers to deployment 02)

Key events during deployment:
1. ‚úÖ ECSRegistry deployed
2. ‚úÖ ECSRegistrar deployed
3. ‚úÖ REGISTRAR_ROLE granted
4. ‚úÖ Registrar params set
5. ‚úÖ Pricing configured
6. ‚úÖ CredentialResolver deployed
7. ‚úÖ Registration committed
8. ‚úÖ All contracts verified on Etherscan

## Support

For issues or questions:
- GitHub: [nxt3d/ecs](https://github.com/nxt3d/ecs)
- Branch: `ecs-v2`
- Commit: `e204f81` - Add resolver update tracking for security

---

**Deployment Operator:** @nxt3d  
**Verified:** ‚úÖ All contracts  
**Production Ready:** Yes, pending registration completion

