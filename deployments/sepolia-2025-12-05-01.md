# ECS V2 Sepolia Deployment Report - v01

**Date:** December 5, 2025  
**Network:** Sepolia (Chain ID: 11155111)  
**Status:** ✅ Deployed (Pending Registration)  
**Version:** v01 - Resolver Update Tracking

## Overview

This deployment includes the new **resolver update tracking** feature that enables clients to enforce security policies based on resolver age. The system now tracks when resolvers are changed, allowing high-security applications to require resolvers to be established (e.g., 90+ days old) before trusting them.

## Key Features Added

### Resolver Trust and Freshness Tracking
- **`resolverUpdated` timestamp** - Tracks when each resolver was last set or changed
- **`getResolverInfo(address)`** - Returns `(string label, uint128 resolverUpdated)`
- **Storage optimization** - Changed `expiration` from `uint256` to `uint128`
- **Security enhancement** - Clients can detect recent resolver changes that may indicate compromise

### Why This Matters

ECS strictly enforces a one-to-one relationship between labels and resolvers. While label owners can change resolvers (necessary for upgrades), this introduces a security concern. By exposing the `resolverUpdated` timestamp, ECS gives clients the tools to enforce their own security policies.

## Deployed Contracts

### Core Contracts

| Contract | Address | Etherscan |
|----------|---------|-----------|
| **ECSRegistry** | `0x4bbf5a0bf9222b3c1d00e6af7bc7835f61afda27` | [View](https://sepolia.etherscan.io/address/0x4bbf5a0bf9222b3c1d00e6af7bc7835f61afda27) |
| **ECSRegistrar** | `0xc272e1355c18010329ab68b456d04fc6e8e78c96` | [View](https://sepolia.etherscan.io/address/0xc272e1355c18010329ab68b456d04fc6e8e78c96) |
| **CredentialResolver** | `0x2ba1277bd3f5638f605696cb974ed67ef81767ec` | [View](https://sepolia.etherscan.io/address/0x2ba1277bd3f5638f605696cb974ed67ef81767ec) |

### Deployment Transactions

| Transaction Type | Hash | Block |
|-----------------|------|-------|
| Deploy ECSRegistrar | `0xe7a99dbb346b43f24ee899713fe4f0c139b5d22683469086ff87596084f54a41` | 9775080 |
| Deploy ECSRegistry | `0x228bf667d1ee95e4351d320f74ab327796f9e9c12ff98db5704e053ffe1cb52d` | 9775080 |
| Grant REGISTRAR_ROLE | `0xb17f7681bd34faadb9d392832fe16503208dc7b3e317e2c1478c292bb2999128` | 9775099 |
| Set Registrar Params | `0x1b005b974c80d2c3eb7486a4feb81e98fdb328525903b9331513cc2cf958f763` | 9775099 |
| Set Pricing | `0xd49ee5016462409efb92b15f2d40f7efbf9cd4454b2dc5d0688a52ee3f6951ce` | 9775099 |
| Deploy CredentialResolver | `0xc8d5b4511f654cc250eb08040f926c4806c282ffd88394829d29f6706346632c` | Pending |
| Commit Registration | `0x0a67fe3e22bf63584aeaf16a94f0781d7a52658b0d064a91bfb20f2e5a0d03b3` | Pending |

## Configuration

- **Root Name:** `ecs.eth`
- **Root Node:** `0xe436ba58406c69a63a9611a11eb52314c5c17ba9eaaa7dab8506fe8849517286`
- **Deployer:** `0xF8e03bd4436371E0e2F7C02E529b2172fe72b4EF`
- **Registrar Pricing:** ~0.001 ETH/year (32000 wei/second)
- **Min Commitment Age:** 60 seconds
- **Min Duration:** 60 seconds
- **Max Duration:** `type(uint64).max`
- **Label Length:** 3-64 characters

## Registration Details

### Commitment Information

- **Label:** `name-stars`
- **Duration:** 365 days
- **Secret:** `0xfe1c585ca728739691170db3e1d514004e1213fa0f0853f9a95dc38a91c56e2a`
- **Commitment Hash:** (see transaction)

## Updated Smart Contract Changes

### ECSRegistry.sol

**Modified Record Struct:**
```solidity
struct Record {
    address owner;
    string label;
    uint128 expiration;      // Changed from uint256
    uint128 resolverUpdated; // NEW: Tracks resolver changes
}
```

**New Function:**
```solidity
function getResolverInfo(address resolver_) 
    external view 
    returns (string memory label, uint128 resolverUpdated)
```

**Replaced Function:**
- ❌ `getLabelByResolver(address) returns (string)` (Removed)
- ✅ `getResolverInfo(address) returns (string, uint128)` (New)

### SDK Changes (ecsjs)

**Updated API:**
```javascript
// Old API (removed)
const label = await getLabelByResolver(client, resolverAddress)

// New API
const { label, resolverUpdated } = await getResolverInfo(client, resolverAddress)
```

## Next Steps

### 1. Wait for Commitment Period (60 seconds)

The commitment was made during deployment. Wait at least 60 seconds before proceeding.

### 2. Complete Registration

Update your `.env` file:
```bash
cat deployments/sepolia-2025-12-05-01.env >> .env
```

Run the registration script:
```bash
source .env && forge script script/RegisterAndSetup.s.sol:RegisterAndSetup \
  --rpc-url $SEPOLIA_RPC_URL --broadcast -vvv
```

### 3. Transfer ENS Manager

After registration completes, update the Manager of `ecs.eth` to the new ECSRegistry:

1. Go to [app.ens.domains](https://app.ens.domains)
2. Navigate to `ecs.eth`
3. Set **Manager** to: `0x4bbf5a0bf9222b3c1d00e6af7bc7835f61afda27`

### 4. Test the Deployment

Test the new `getResolverInfo` function:
```bash
# Using cast
cast call 0x4bbf5a0bf9222b3c1d00e6af7bc7835f61afda27 \
  "getResolverInfo(address)(string,uint128)" \
  0x2ba1277bd3f5638f605696cb974ed67ef81767ec \
  --rpc-url $SEPOLIA_RPC_URL

# Using ecsjs (after registration)
npm run hook
```

## Testing Resolver Trust

Example of implementing a trust policy:

```javascript
import { getResolverInfo, createECSClient, sepolia } from '@nxt3d/ecsjs'

const client = createECSClient({
  chain: sepolia,
  rpcUrl: 'https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY'
})

const { label, resolverUpdated } = await getResolverInfo(
  client, 
  '0x2ba1277bd3f5638f605696cb974ed67ef81767ec'
)

const MIN_RESOLVER_AGE = 90 * 24 * 60 * 60 // 90 days
const resolverAge = Math.floor(Date.now() / 1000) - Number(resolverUpdated)

if (resolverAge < MIN_RESOLVER_AGE) {
  console.warn(`⚠️ Resolver "${label}" changed ${Math.floor(resolverAge / 86400)} days ago`)
  console.warn(`Security review required before accepting credentials.`)
} else {
  console.log(`✅ Resolver stable for ${Math.floor(resolverAge / 86400)} days`)
}
```

## Trust Policy Recommendations

Different applications should implement different trust policies:

- **High Security Apps** (wallets, financial): Require 90+ days of resolver stability
- **Standard Apps** (social, identity): Require 30 days of resolver stability
- **Low Risk Apps** (public profiles): Require 7 days of resolver stability
- **Development/Testing**: Accept any resolver age

## Version History

### v01 (December 5, 2025)
- Initial deployment with resolver update tracking
- Added `resolverUpdated` timestamp to Record struct
- Replaced `getLabelByResolver` with `getResolverInfo`
- Changed `expiration` from `uint256` to `uint128`
- Updated SDK and all helper scripts
- All tests passing (64/64)

## Contract Verification

Contracts will be automatically verified on Sepolia Etherscan using the deployment script with `--verify` flag.

## Related Documentation

- [README.md](../README.md) - Project overview and usage
- [Resolver Trust Documentation](../README.md#resolver-trust-and-freshness) - Security policies
- [ENSIP: Resolver Info Text Record](https://github.com/nxt3d/ensips/blob/resolver-info-metadata/ensips/resolver-info-text-record.md) - Planned upgrade announcements

## Notes

- This is the first deployment with the resolver tracking feature
- The old deployment (v03 from Dec 2) did not have resolver tracking
- Clients upgrading from the old SDK should update to use `getResolverInfo` instead of `getLabelByResolver`
- The `resolverUpdated` timestamp is set during both initial registration and when resolvers are changed

## Support

For issues or questions:
- GitHub: [nxt3d/ecs](https://github.com/nxt3d/ecs)
- Branch: `ecs-v2`

---

**Deployment Operator:** @nxt3d  
**Commit:** `e204f81` - Add resolver update tracking for security

